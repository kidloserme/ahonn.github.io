<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Ahonn"><meta name="description" content="翻译自StackOverflow:HowcanIpreventSQL-injectioninPHP?中的高票答案Question如果用户输入的数据没有经过修正，那么应用将会很容易受到SQL注入攻击，像下面的这个例子一样：123$unsafe_vari"><meta name="keywords" content="PHP,StackOverflow,SQL"><title>在 PHP 中如何预防 SQL 注入 · Ahonn</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="http://yoursite.com/2015/12/21/how-can-i-prevent-sql-injection-in-php/"><link rel="alternate" href="/atom.xml" title="Ahonn"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?b54ec1817ee20d83af77a0859c4dda5d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-74273646-1', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">Ahonn</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/tags/" target="_self">Tags</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">在 PHP 中如何预防 SQL 注入</h1><span class="post-time">Dec 21, 2015</span><div id="sidebar" class="post-sidebar"><h3 class="heading">Contents</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Question"><span class="toc-text">Question</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Answer"><span class="toc-text">Answer</span></a></li></ol></div><div class="post-content"><blockquote>
<p>翻译自 Stack Overflow: <a href="http://stackoverflow.com/questions/60174/how-can-i-prevent-sql-injection-in-php" target="_blank" rel="external">How can I prevent SQL-injection in PHP?</a> 中的高票答案</p>
</blockquote>
<h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><p>如果用户输入的数据没有经过修正，那么应用将会很容易受到 SQL 注入攻击，像下面的这个例子一样：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$unsafe_variable = $_POST[<span class="string">'user_input'</span>]; </div><div class="line"></div><div class="line">mysql_query(<span class="string">"INSERT INTO `table` (`column`) VALUES ('$unsafe_variable')"</span>);</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>上面的例子，会因为用户输入像 <code>value&#39;); DROP TABLE table;--</code> 这样的数据，使得 SQL 语句变成：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">INSERT INTO `table` (`column`) VALUES(&apos;value&apos;); DROP TABLE table;--&apos;)</div></pre></td></tr></table></figure></p>
<p>应该如何去预防这样的事情发生？</p>
<h2 id="Answer"><a href="#Answer" class="headerlink" title="Answer"></a>Answer</h2><p><strong>使用预处理语句以及参数化查询来预防 SQL 注入</strong></p>
<p>在发送到数据库前，对每一个参数进行解析。这种处理方式是不可能受到攻击者恶意 SQL 注入的。</p>
<p>有两种基本操作可以选择，来达到这个目的：</p>
<ul>
<li><p>使用 PDO(PHP Data Objects)：支持所有的主流数据库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$stmt = $pdo-&gt;prepare(<span class="string">'SELECT * FROM employees WHERE name = :name'</span>);</div><div class="line"></div><div class="line">$stmt-&gt;execute(<span class="keyword">array</span>(<span class="string">'name'</span> =&gt; $name));</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($stmt <span class="keyword">as</span> $row) &#123;</div><div class="line">    <span class="comment">// do something with $row</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>使用 MySQLi：支持 MySQL 数据库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$stmt = $dbConnection-&gt;prepare(<span class="string">'SELECT * FROM employees WHERE name = ?'</span>);</div><div class="line">$stmt-&gt;bind_param(<span class="string">'s'</span>, $name);</div><div class="line"></div><div class="line">$stmt-&gt;execute();</div><div class="line"></div><div class="line">$result = $stmt-&gt;get_result();</div><div class="line"><span class="keyword">while</span> ($row = $result-&gt;fetch_assoc()) &#123;</div><div class="line">    <span class="comment">// do something with $row</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>如果连接到 MySQL 之外的数据库，有其他的驱动可以选择，例如 <code>PostgreSQL</code> 可以使用 <code>pg_prepare()</code> 和 <code>pg_execute()</code>。PDO 是一个比较普遍的选择，因为它可以兼容更多的数据库。</p>
<p><strong>正确的建立连接</strong><br>注意，当使用PDO访问MySQL数据库时，默认不使用预处理语句。要解决这个问题，需要禁用预处理语句的模拟 <code>ATTR_EMULATE_PREPARES</code> 。</p>
<blockquote>
<p><strong>PDO::ATTR_EMULATE_PREPARES:</strong><br>启用或禁用预处理语句的模拟。 有些驱动不支持或有限度地支持本地预处理。使用此设置强制PDO总是模拟预处理语句（如果为 TRUE ），或试着使用本地预处理语句（如果为 FALSE）。如果驱动不能成功预处理当前查询，它将总是回到模拟预处理语句上。 需要 bool 类型。</p>
</blockquote>
<p>一个正确建立 PDO 连接的例子：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$dbConnection = <span class="keyword">new</span> PDO(<span class="string">'mysql:dbname=dbtest;host=127.0.0.1;charset=utf8'</span>, <span class="string">'user'</span>, <span class="string">'pass'</span>);</div><div class="line"></div><div class="line">$dbConnection-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, <span class="keyword">false</span>);</div><div class="line">$dbConnection-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);</div></pre></td></tr></table></figure></p>
<p>在上面的例子中错误模式并不是必要的，但建议添加它。这样脚本就不会因为一个致命错误而报错停止，让开发人员有机会去捕捉抛出的异常并进行处理。</p>
<p>第一个 <code>setAttribute()</code> 是告诉 PDO 禁用预处理语句的模拟，使用真正准备好的预处理语句。这确保语句与值不会在 PHP 解析之前就发送到 MySQL。尽管你可以在选项中设置字符集的构造函数，但是要注意，PHP版本 &lt; 5.3.6，默认无视 DSN 的字符参数。</p>
<p><strong>额外说明</strong><br>SQL 语句会通过预处理解析以及数据库的编译。通过指定参数(例如 ? 或者 :name 之类的参数)，告诉数据库引擎那些是你想要过滤的。当执行语句时，预处理过的语句将会结合参数去执行。</p>
<p>最重要的是，参数值结合编译的语句之后，它不是一个 SQL 字符串。SQL 注入是通过恶意字符串创建 SQL 发送到数据库的一种攻击。所以分开发送实际的 SQL 参数，可以降低被注入的风险，避免造成一些不希望看到的结果。任何发送的参数，将会在使用预处理之后被当做是字符串。</p>
<p>在上面的例子中，如果变量 <code>$name</code> 的值是 <code>&#39;Sarah&#39;; DELETE FROM employees</code>，那么结果将会是查找字符串 <code>&quot;&#39;Sarah&#39;; DELETE FROM employees&quot;</code>，而且也将不会得到一个空表。（即是后面的 <code>DELETE FROM employees</code> 将被当成字符串，而不是当做 SQL 语句去执行）</p>
<blockquote>
<p>使用预处理语句的另一个好处是，如果你在同一个会话中多次执行相同的语句，语句只会被解析和编译一次，在速度上也有一点提升。</p>
</blockquote>
<p>下面是一个使用 PDO 来插入数据的例子：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$preparedStatement = $db-&gt;prepare(<span class="string">'INSERT INTO table (column) VALUES (:column)'</span>);</div><div class="line"></div><div class="line">$preparedStatement-&gt;execute(<span class="keyword">array</span>(<span class="string">'column'</span> =&gt; $unsafeValue));</div></pre></td></tr></table></figure></p>
<p><strong>动态查询</strong><br>动态查询依旧可以使用预处理语句去进行，对用某些不能参数化的数据，可以使用白名单来限制可能的值。例如：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Value whitelist</span></div><div class="line">  <span class="comment">// $dir can only be 'DESC' or 'ASC'</span></div><div class="line">$dir = !<span class="keyword">empty</span>($direction) ? <span class="string">'DESC'</span> : <span class="string">'ASC'</span>;</div></pre></td></tr></table></figure></p>
<p>总之，对于用户输入的所有数据都应该在发送到数据库查询之前进行预处理，以此来过滤那些不安全的参数。使得不会因为被 SQL 注入攻击而产生意想不到的结果。</p>
</div></article><div class="tags"><a href="/tags/PHP/">PHP</a><a href="/tags/StackOverflow/">StackOverflow</a><a href="/tags/SQL/">SQL</a></div><div class="paginator"><a href="/2015/12/31/2015-summary/" class="prev"><i class="iconfont icon-left"></i><span> Prev</span></a><a href="/2015/12/19/simple-use-of-the-php-curl-library/" class="next"><span>Next</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div id="disqus_thread"></div></section><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://yoursite.com/2015/12/21/how-can-i-prevent-sql-injection-in-php/';
    this.page.identifier = '2015/12/21/how-can-i-prevent-sql-injection-in-php/';
    this.page.title = '在 PHP 中如何预防 SQL 注入';
};
(function() {
var d = document, s = d.createElement('script');

s.src = '//ahonn.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();</script></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2015-2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Ahonn</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>